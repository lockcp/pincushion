<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Pinboard - Save a Bookmark</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, minimal-ui">
  <meta name="apple-touch-fullscreen" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge, chrome=1">

  <link rel="stylesheet" href="popup.css">
  <link rel="stylesheet" href="autocomplete.css">

  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.0.min.js"></script>
  <script type="text/javascript" src="popup.js"></script>

  <script type="text/javascript" src="https://pinboard.in/user_tag_list/?auth_token="></script>

  <link rel="shortcut icon" type="image/x-icon" href="https://pinboard.in/favicon.ico">
</head>

<body>

<div id="popup_header">
  <form method="post" action="https://pinboard.in/logout/" id="logout"><input type="submit" value="log out"></form>
  <div id="title"><a href="https://pinboard.in/">Pinboard</a></div>
</div>

<form method="post" action="https://pinboard.in/add">
  <input type="hidden" name="next" value="">
  <table>
  <tr>
    <th><label for="pin-title">title</label></th>
    <td><input type="text" name="title" id="pin-title" size="70" autocomplete="off" autocapitalize="off"></td>
  </tr>
  <tr>
    <th><label for="url">URL</label></th>
    <td><input type="text" name="url" id="url" size="70" autocorrect="off"></td>
  </tr>
  <tr>
    <th><label for="description">description</label></th>
    <td><textarea name="description" id="description" cols="70" rows="11" autocomplete="off" autocapitalize="off"></textarea></td>
  </tr>
  <tr>
    <th style="vertical-align: top"><label for="tags">tags</label></th>
    <td><input type="text" name="tags" id="tags" size="70" autocomplete="off" autocorrect="off" autocapitalize="off"></td>
  </tr>

  <tr id="suggestion_row" style="height: 30px; visibility: hidden;">
    <th>suggest</th>
    <td id="suggested"></td>
  </tr>

  <tr>
    <td></td>
    <td id="modifiers">
      <label><input type="checkbox" name="private" id="private"> private</label>
      <label><input type="checkbox" name="toread" id="toread"> read later</label>
    </td>
  </tr>

  <tr>
    <td></td>
    <td><input type="submit" value="add bookmark"></td>
  </tr>
  </table>

</form>

<script type="text/javascript">

  function get_suggested_tags() {
    //var tags = ["\\o/", "'''", "\"", "'\"'\"\"\\"];
    // show_suggested_tags(tags);
    var url = '';
    var req = "https://pinboard.in/ajax_suggest?url=" + encodeURIComponent(url);
    GET(req, show_suggested_tags);
  }

  function show_suggested_tags(tags) {
    if (!tags) { return; }
    var row = document.getElementById("suggestion_row");
    row.style.visibility = 'visible';
    var cell = document.getElementById("suggested");
    var links = [];
    for (var i = 0; i < tags.length; i++) {
      var tag = tags[i];
      var escaped = pin_escape(tag);
      var cooked  = pin_cook(tag);
      var link = '<a href="#" class="suggested_tag" onclick="add_tag(\''  +
                  escaped + '\'); return false;">' + cooked + '</a>&nbsp;';
      links.push(link);
    }
    cell.innerHTML = links.join(" ");
  }

  RegExp.escape = function(text) {
    return text.replace(/[-[\]{}()*+?.,\\\\'"^$|#\s]/g, "\\$&"); //"'
  }

  function add_tag(t) {
    var field = document.getElementById('tags');
    var curr = field.value;
    var tag_regex = new RegExp( "(\\b|\\s)" + RegExp.escape(t) + "(\\b|\\s)");
    if (curr.match(tag_regex) == null) {
      // TODO handle case when tag is at start of field
      field.value += " " + t;
    }
    return false;
  }

  function run_request(type, url, data, callback) {
    var req = new XMLHttpRequest();
    req.onreadystatechange = function() {
      if (req.readyState == 4 || req.readyState == "complete") {
        var t = req.responseText;
        if (t.length) {
          var results = eval("(" + t + ")");
        }
        callback(results);
      }
    };

    req.open(type,url,true);
    req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");
    req.send(data);
  }

  function winclose(e) {
    var code;
    if (e.keyCode) {
      code = e.keyCode;
    } else {
      if (e.which) {
        code = e.which;
      }
    }
    if (code == 27) {
      if (!(pin_tagcomplete && pin_tagcomplete.active())) {
        window.close();
      }
    }
  }

  function GET(url, callback) {
    run_request('GET', url, null, callback);
  }

  function PIN_destroyer() {
    var form;
    var action;
    var curr_delete;

    this.init = function(form,action) {
      this.form = document.forms[form];
      this.action = action;
    };

    this.destroy = function(id) {
      var f = document.forms['delete'];
      this.form.elements['id'].value = id;
      this.form.elements['action'].value = this.action;
      this.form.submit();
    };

    this.show_destroy = function(id) {
      this.cancel();
      var del = document.getElementById("delete_" + id);
      var dest = document.getElementById("destroy_" + id);
      del.style.visibility = "hidden";
      del.style.display = "none";
      dest.style.visibility = "visible";
      dest.style.display = "inline";

      this.curr_delete = id;
    };

    this.cancel = function() {
      if (!this.curr_delete) { return; }
      var del = document.getElementById("delete_" + this.curr_delete);
      var dest = document.getElementById("destroy_" + this.curr_delete);
      dest.style.visibility = "hidden";
      dest.style.display = "none";
      del.style.visibility = "visible";
      del.style.display = "inline";
    };
  }
  var dst;

  dst = new PIN_destroyer();
  dst.init('delete', 'delete');
</script>

<script type="text/javascript" src="https://pinboard.in/js/pin.js?ayyew"></script>
<script type="text/javascript">
  var pin_tagcomplete;
  Pin.Event.listen(window, 'load', function(e) {
    pin_tagcomplete = new Pin.Tags('tags', usertags, {circular: true, submit_on_return: true });
  });

  if (document.addEventListener) {
    document.addEventListener('keydown', winclose, false);
  } else {
    document.attachEvent('onkeydown', winclose);
  }
</script>

</body>
</html>