function resizeWindow(){var min_width=600,min_height=700;window.outerHeight<min_height&&window.resizeTo(min_width,min_height),document.addEventListener?document.addEventListener("keydown",winclose,!1):document.attachEvent("onkeydown",winclose)}function parseUrlParameters(){(window.onpopstate=function(){var match,pl=/\+/g,search=/([^&=]+)=?([^&]*)/g,decode=function(s){return decodeURIComponent(s.replace(pl," "))},query=window.location.search.substring(1);for(urlParams={};match=search.exec(query);)urlParams[decode(match[1])]=decode(match[2])})(),$("input#url").val(urlParams.url),$("input#title").val(urlParams.title),$("textarea#description").val(urlParams.description),$("#suggestion_row, #suggested").hide()}function authenticate(){urlParams.user&&urlParams.token||(alert("You must provide both ‘user’ and ‘token’ parameters to this page to allow it to use the Pinboard API."),$("#submit").addClass("fail"),$("#submit").prop("disabled",!0),$("#spinner").addClass("hidden"))}function auth_token(){return urlParams.user+":"+urlParams.token}function serialized_inputs(){var serialized_inputs=$("#url, #title, #description, #tags").serialize();return $("#private").prop("checked")&&(serialized_inputs+="&shared=no"),$("#toread").prop("checked")&&(serialized_inputs+="&toread=yes"),serialized_inputs}function check_for_existing_bookmark_details(){if(urlParams.url){var bookmark_details_api="https://pinboard-bridge.herokuapp.com/posts/get?format=json&auth_token="+auth_token()+"&url="+urlParams.url;$.get(bookmark_details_api,"json").done(function(response){if(!(response.posts.length<1)){var bookmark=response.posts[0];if($("input#title").val(bookmark.description),$("textarea#description").val(bookmark.extended),prepopulate_tags(bookmark.tags),"no"==bookmark.shared&&$("#private").prop("checked",!0),"yes"==bookmark.toread&&$("#toread").prop("checked",!0),bookmark.time){var date=new Date(bookmark.time);$("#bookmark-status").text("Previously saved on "+date.getFullYear()+"/"+date.getMonth()+"/"+date.getDate())}$("#submit span.text").text("Update bookmark"),$("#spinner").addClass("hidden")}}).fail(function(response){"401"==response.status&&alert("401 Unauthorised. Please check your username and API access token.")})}}function setUpFormSubmission(){$("#post-to-pinboard").on("submit",function(event){event.preventDefault();var post_bookmark_api="https://pinboard-bridge.herokuapp.com/posts/add?format=json&auth_token="+auth_token()+"&"+serialized_inputs();$.get(post_bookmark_api,"json").done(function(response){"done"==response.result_code?(console.log("Bookmark saved correctly."),Ladda.stopAll(),$("#submit").addClass("success"),setTimeout(function(){window.close(),$("#submit").removeClass("success")},900)):"must provide title"==response.result_code&&(Ladda.stopAll(),$("#submit").addClass("fail"),setTimeout(function(){$("#submit").removeClass("fail")},1900),$("#title").focus())}).fail(function(response){Ladda.stopAll(),$("#submit").addClass("fail"),"401"==response.status&&alert("401 Unauthorised. Please check your username and API access token.")})}),$("input, textarea").on("blur",function(){$("body").animate({scrollTop:0},200)})}function prepopulate_tags(tagString){for(var tags=tagString.split(" "),i=0;i<tags.length;i++)$("input#tags")[0].selectize.addOption({label:tags[i]}),$("input#tags")[0].selectize.addItem(tags[i])}function setUpTagAutoComplete(){if($("input#tags").selectize({delimiter:" ",create:!0,openOnFocus:!1,maxOptions:6,persist:!1,hideSelected:!0,diacritics:!0,valueField:"label",labelField:"label",searchField:["label"],plugins:["restore_on_backspace"]}),localStorage&&localStorage.tags){var user_tags=JSON.parse(localStorage.tags);console.log("Populating dropdown."),$.each(user_tags,function(key){$("input#tags")[0].selectize.addOption({label:key})})}}function get_suggested_tags(){if(urlParams.url){var suggested_tags_api="https://pinboard-bridge.herokuapp.com/posts/suggest?format=json&url="+urlParams.url+"&auth_token="+auth_token();$("#spinner").removeClass("hidden"),$.get(suggested_tags_api,function(data){show_suggested_tags(data),$("#spinner").addClass("hidden")},"json")}}function update_user_tags(){if(localStorage.tags)console.log("Have tags already.");else{console.log("Downloading user’s tags."),localStorage.tags=JSON.stringify([]);var all_tags_api="https://pinboard-bridge.herokuapp.com/tags/get?format=json&auth_token="+auth_token();$.get(all_tags_api,"json").done(function(response){localStorage.tags=JSON.stringify(response),localStorage["tags-updated"]=new Date}).fail(function(response){"401"==response.status&&alert("401 Unauthorised. Please check your username and API access token.")})}}function show_suggested_tags(tag_suggestions){if(tag_suggestions){tag_suggestions=$.merge(tag_suggestions[0].popular,tag_suggestions[1].recommended),tag_suggestions=tag_suggestions.map(function(tag){return tag.toLowerCase()}),tag_suggestions=$.unique(tag_suggestions),$("#description"),tag_suggestions=removeSpuriousResults(tag_suggestions),tag_suggestions=removeOverlyCommonTags(tag_suggestions);for(var suggested_tags=[],i=0;i<tag_suggestions.length;i++){var suggested_tag=tag_suggestions[i],escaped=pin_escape(suggested_tag),cooked=pin_cook(suggested_tag),suggested_tag='<button type="button" class="suggested_tag" onclick="add_tag(\''+escaped+"'); $(this).hide(200); return false;\">"+cooked+"</button>";suggested_tags.push(suggested_tag)}suggested_tags.length>0?($("#suggested").append(suggested_tags.join(" ")),$("#suggestion_row").show(),$("#suggested").show(800)):($("#suggestion_row th").addClass("none").text("No tag suggestions for this page."),$("#suggestion_row").show())}}function removeSpuriousResults(tag_suggestions){return $.inArray("facebook",tag_suggestions)>=0&&$.inArray("googlereader",tag_suggestions)>=0&&$.inArray("ifttt",tag_suggestions)>=0&&$.inArray("objective-c",tag_suggestions)>=0&&$.inArray("twitter",tag_suggestions)>=0&&$.inArray("twitterlink",tag_suggestions)>=0&&$.inArray("wsh",tag_suggestions)>=0&&$.inArray("music",tag_suggestions)>=0&&$.inArray("04:22pm",tag_suggestions)>=0&&$.inArray("1960s",tag_suggestions)>=0?[]:tag_suggestions}function removeOverlyCommonTags(tag_suggestions){return tag_suggestions=$.grep(tag_suggestions,function(tag){return tag=tag.toLowerCase(),"bookmarks_bar"!=tag&&"pin-later"!=tag&&"unread"!=tag&&"*resources"!=tag&&"unlabeled"!=tag&&"via:packrati.us"!=tag&&"bookmarks_menu"!=tag&&"from"!=tag&&"ifttt"!=tag&&"later"!=tag&&"saved"!=tag&&"read"!=tag&&"feedly"!=tag&&"for"!=tag&&"recently"!=tag&&"tobookmarks"!=tag&&"from:ifttt"!=tag&&"instapaper"!=tag&&"!fromtwitter"!=tag&&"feedbin"!=tag&&"favorites_bar"!=tag&&"imported"!=tag&&".dailybrowse"!=tag&&"barra_dei_preferiti"!=tag&&"bookmarks_toolbar"!=tag})}function pin_escape(s){return s=s.replace(/\\/g,"\\\\"),s=s.replace(/'/g,"\\'"),s=s.replace(/"/g,"&quot;")}function pin_cook(s){return s=s.replace(/</g,"&lt;"),s=s.replace(/>/g,"&gt;"),s=s.replace(/"/g,"&quot;")}function add_tag(tag){$("input#tags")[0].selectize.addOption({label:tag}),$("input#tags")[0].selectize.addItem(tag)}function pin_sort(a,b){var l=a.toLowerCase?a.toLowerCase():a,r=b.toLowerCase?b.toLowerCase():b;return l==r?0:l>r?1:-1}function winclose(e){var code;e.keyCode?code=e.keyCode:e.which&&(code=e.which),27==code&&(pin_tagcomplete&&pin_tagcomplete.active()||window.close())}var urlParams;$(function(){resizeWindow(),parseUrlParameters(),authenticate(),FastClick.attach(document.body),setUpFormSubmission(),setUpTagAutoComplete(),check_for_existing_bookmark_details(),get_suggested_tags(),update_user_tags(),$("input#tags")[0].selectize.focus(),Ladda.bind("button[type=submit]")}),RegExp.escape=function(text){return text.replace(/[-[\]{}()*+?.,\\\\'"^$|#\s]/g,"\\$&")};